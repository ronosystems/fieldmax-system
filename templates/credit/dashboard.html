{% extends 'credit/base.html' %}
{% load static %}

{% block title %}Credit Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-line me-2"></i>Credit Dashboard</h2>
    <div>
        <span class="text-muted">Last updated: {% now "F j, Y H:i" %}</span>
        <span class="ms-3">
            <a href="{% url 'credit:transaction_list' %}" class="btn btn-sm btn-primary"><i class="fas fa-eye me-1"></i>View Transactions</a>
            <a href="{% url 'credit:company_list' %}" class="btn btn-sm btn-secondary"><i class="fas fa-building me-1"></i>View Companies</a>
        </span> 
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card" style="border-left: 5px solid #e74c3c;">
            <div class="stat-value">KSH {{ total_pending|default:"0"|floatformat:0 }}</div>
            <div class="stat-label">Pending Payments</div>
            <i class="fas fa-clock stat-icon" style="color: #e74c3c;"></i>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card" style="border-left: 5px solid #2ecc71;">
            <div class="stat-value">KSH {{ total_paid|default:"0"|floatformat:0 }}</div>
            <div class="stat-label">Paid Amount</div>
            <i class="fas fa-check-circle stat-icon" style="color: #2ecc71;"></i>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card" style="border-left: 5px solid #f39c12;">
            <div class="stat-value">{{ pending_count|default:"0" }}</div>
            <div class="stat-label">Pending Transactions</div>
            <i class="fas fa-spinner stat-icon" style="color: #f39c12;"></i>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card" style="border-left: 5px solid #3498db;">
            <div class="stat-value">{{ paid_count|default:"0" }}</div>
            <div class="stat-label">Completed Transactions</div>
            <i class="fas fa-check-double stat-icon" style="color: #3498db;"></i>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-line me-2"></i>Credit Trends (Last 30 Days)
            </div>
            <div class="card-body">
                <canvas id="creditChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>Payment Status
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Companies Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-building me-2"></i>Top Credit Companies</span>
                <a href="{% url 'credit:company_list' %}" class="btn btn-sm btn-warning">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Pending Amount</th>
                                <th>Paid Amount</th>
                                <th>Transactions</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for company in companies %}
                            <tr>
                                <td class="fw-bold">{{ company.name }}</td>
                                <td>{{ company.contact_person|default:"-" }}<br>
                                    <small>{{ company.phone }}</small>
                                </td>
                                <td class="amount-pending">KSH {{ company.pending_amount|default:"0"|floatformat:0 }}
                                <td class="amount-paid">KSH {{ company.paid_total|default:"0"|floatformat:0 }}</td>
                                <td>{{ company.transaction_count }}</td>
                                <td>
                                    {% if company.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">No companies found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-history me-2"></i>Recent Credit Transactions</span>
                <a href="{% url 'credit:transaction_list' %}" class="btn btn-sm btn-warning">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Customer</th>
                                <th>Company</th>
                                <th>Product</th>
                                <th>Amount</th>
                                <th>Date Given</th>
                                <th>Days</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in recent_transactions %}
                            <tr>
                                <td><span class="badge bg-warning text-dark">{{ transaction.transaction_id }}</span></td>
                                <td>
                                    <a href="{% url 'credit:customer_detail' transaction.customer.id %}" class="text-decoration-none">
                                        {{ transaction.customer.full_name }}
                                    </a>
                                </td>
                                <td>{{ transaction.credit_company.name }}</td>
                                <td>{{ transaction.product.product_code }}</td>
                                <td class="fw-bold">KSH {{ transaction.ceiling_price|floatformat:0 }}</td>
                                <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                                <td>
                                    {% with days=transaction.days_since_given %}
                                        {% if days > 90 %}
                                            <span class="badge bg-danger">{{ days }} days</span>
                                        {% elif days > 60 %}
                                            <span class="badge bg-warning text-dark">{{ days }} days</span>
                                        {% elif days > 30 %}
                                            <span class="badge bg-info">{{ days }} days</span>
                                        {% else %}
                                            <span class="badge bg-success">{{ days }} days</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% if transaction.payment_status == 'pending' %}
                                        <span class="badge bg-danger">Pending</span>
                                    {% elif transaction.payment_status == 'paid' %}
                                        <span class="badge bg-success">Paid</span>
                                    {% elif transaction.payment_status == 'cancelled' %}
                                        <span class="badge bg-secondary">Cancelled</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center py-4">No transactions found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* global Chart */
(function() {
    'use strict';
    
    document.addEventListener('DOMContentLoaded', function() {
        // Credit Trend Chart
        var creditChartEl = document.getElementById('creditChart');
        if (creditChartEl) {
            var ctx1 = creditChartEl.getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: {{ chart_labels|safe|default:"[]" }},
                    datasets: [
                        {
                            label: 'New Credit (KSH)',
                            data: {{ credit_data|safe|default:"[]" }},
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Payments Received (KSH)',
                            data: {{ payment_data|safe|default:"[]" }},
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Status Distribution Chart
        var statusChartEl = document.getElementById('statusChart');
        if (statusChartEl) {
            var ctx2 = statusChartEl.getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Paid', 'Cancelled'],
                    datasets: [{
                        data: [
                            {{ pending_count|default:0 }},
                            {{ paid_count|default:0 }},
                            {{ cancelled_count|default:0 }}
                        ],
                        backgroundColor: ['#e74c3c', '#2ecc71', '#95a5a6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    });
})();
</script>
{% endblock %}
{% extends 'credit/staff_base.html' %}
{% load static %}

{% block title %}Credit Manager Dashboard - FieldMax{% endblock %}

{% block extra_css %}
<style>
    .welcome-card {
        background: linear-gradient(135deg, #6f42c1, #e83e8c);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .welcome-title {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .welcome-subtitle {
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .date-badge {
        background: rgba(255,255,255,0.2);
        padding: 8px 15px;
        border-radius: 50px;
        display: inline-block;
        margin-top: 15px;
    }
    
    .quick-stats {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .quick-stat-item {
        background: rgba(255,255,255,0.1);
        padding: 15px 25px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        flex: 1;
        min-width: 150px;
        text-align: center;
    }
    
    .quick-stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .quick-stat-label {
        font-size: 0.85rem;
        opacity: 0.8;
        margin-top: 5px;
    }
    
    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .action-card {
        background: white;
        border-radius: 12px;
        padding: 20px 15px;
        text-align: center;
        text-decoration: none;
        color: #333;
        transition: all 0.3s;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .action-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(111, 66, 193, 0.2);
        border-color: #6f42c1;
    }
    
    .action-card i {
        font-size: 2rem;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #6f42c1, #e83e8c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .action-card span {
        display: block;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .action-card small {
        color: #666;
        font-size: 0.75rem;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        height: 100%;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .chart-title i {
        color: #6f42c1;
        margin-right: 8px;
    }
    
    .chart-wrapper {
        height: 250px;
        position: relative;
    }
    
    .company-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border: 1px solid #e0e0e0;
        transition: all 0.3s;
    }
    
    .company-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-left: 4px solid #6f42c1;
    }
    
    .company-name {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .company-stats {
        display: flex;
        gap: 20px;
        font-size: 0.9rem;
        color: #666;
    }
    
    .badge-company {
        background: linear-gradient(135deg, #6f42c1, #e83e8c);
        color: white;
        padding: 3px 10px;
        border-radius: 50px;
        font-size: 0.7rem;
        font-weight: 600;
    }
    
    .risk-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .risk-low { background: #28a745; }
    .risk-medium { background: #ffc107; }
    .risk-high { background: #dc3545; }
    
    .due-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .due-item:last-child {
        border-bottom: none;
    }
    
    .due-customer {
        font-weight: 600;
    }
    
    .due-amount {
        font-weight: 700;
        color: #6f42c1;
    }
    
    .due-date {
        font-size: 0.8rem;
        color: #666;
    }
    
    .due-overdue {
        color: #dc3545;
        font-weight: 600;
        font-size: 0.8rem;
    }
    
    /* Status Badges */
    .badge-active {
        background: #d4edda;
        color: #155724;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge-pending {
        background: #fff3cd;
        color: #856404;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge-overdue {
        background: #f8d7da;
        color: #721c24;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge-paid {
        background: #cce5ff;
        color: #004085;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .text-highlight {
        color: #6f42c1;
        font-weight: 700;
    }
    
    @media (max-width: 768px) {
        .welcome-title {
            font-size: 1.5rem;
        }
        
        .quick-stats {
            flex-direction: column;
        }
        
        .quick-stat-item {
            width: 100%;
        }
        
        .action-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block page_icon %}fas fa-chart-pie{% endblock %}
{% block page_title %}Credit Manager Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'credit:dashboard' %}">Credit</a></li>
<li class="breadcrumb-item active">Manager Dashboard</li>
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'credit:transaction_create' %}" class="btn btn-primary-custom btn-custom">
        <i class="fas fa-plus-circle me-2"></i>New Credit
    </a>
    <button type="button" class="btn btn-outline-custom btn-custom dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fas fa-download"></i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
        <li><h6 class="dropdown-header">Export Reports</h6></li>
        <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2 text-danger"></i>Credit Report</a></li>
        <li><a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2 text-success"></i>Collections Report</a></li>
        <li><a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2 text-warning"></i>Defaulters List</a></li>
    </ul>
</div>
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="welcome-card animate__animated animate__fadeIn">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="welcome-title">
                <i class="fas fa-chart-pie me-3"></i>Credit Manager Dashboard
            </h1>
            <p class="welcome-subtitle">
                <i class="fas fa-calendar-alt me-2"></i>{{ today|date:"l, F j, Y" }}
                <span class="mx-2">|</span>
                <i class="fas fa-clock me-2"></i>{{ today|time:"H:i" }}
            </p>
            
            <div class="date-badge">
                <i class="fas fa-credit-card me-2"></i>
                <strong>{{ total_transactions|default:"0" }}</strong> total credit |
                <strong>{{ active_credits|default:"0" }}</strong> active |
                <strong>KES {{ total_outstanding|default:"0"|floatformat:0 }}</strong> outstanding
            </div>

            <div class="quick-stats">
                <div class="quick-stat-item">
                    <div class="quick-stat-value">{{ due_today|default:"0" }}</div>
                    <div class="quick-stat-label">Due Today</div>
                </div>
                <div class="quick-stat-item">
                    <div class="quick-stat-value">KES {{ collected_today|default:"0"|floatformat:0 }}</div>
                    <div class="quick-stat-label">Collected Today</div>
                </div>
                <div class="quick-stat-item">
                    <div class="quick-stat-value">{{ overdue_count|default:"0" }}</div>
                    <div class="quick-stat-label">Overdue</div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
            <i class="fas fa-credit-card fa-5x" style="opacity: 0.5;"></i>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="action-grid">
    <a href="{% url 'credit:transaction_create' %}" class="action-card">
        <i class="fas fa-plus-circle"></i>
        <span>New Credit</span>
        <small>Create transaction</small>
    </a>
    <a href="{% url 'credit:transaction_list' %}" class="action-card">
        <i class="fas fa-list"></i>
        <span>Transactions</span>
        <small>View all</small>
    </a>
    <a href="{% url 'credit:customer_add' %}" class="action-card">
        <i class="fas fa-user-plus"></i>
        <span>Add Customer</span>
        <small>New customer</small>
    </a>
    <a href="{% url 'credit:company_list' %}" class="action-card">
        <i class="fas fa-building"></i>
        <span>Companies</span>
        <small>Credit partners</small>
    </a>
    <a href="#" class="action-card">
        <i class="fas fa-file-invoice"></i>
        <span>Collections</span>
        <small>Due payments</small>
    </a>
    <a href="#" class="action-card">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Defaulters</span>
        <small>{{ overdue_count|default:"0" }} accounts</small>
    </a>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-credit-card"></i>
        </div>
        <div class="stat-value">{{ total_transactions|default:"0" }}</div>
        <div class="stat-label">Total Credit</div>
        <div class="stat-trend">
            <i class="fas fa-calendar me-1"></i>{{ this_month_count|default:"0" }} this month
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-value">KES {{ total_outstanding|default:"0"|floatformat:0 }}</div>
        <div class="stat-label">Outstanding</div>
        <div class="stat-trend">
            <i class="fas fa-check-circle me-1"></i>{{ paid_count|default:"0" }} paid
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-value">{{ pending_approval|default:"0" }}</div>
        <div class="stat-label">Pending Approval</div>
        <div class="stat-trend down">
            <i class="fas fa-hourglass me-1"></i>Awaiting review
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon danger">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-value">{{ overdue_count|default:"0" }}</div>
        <div class="stat-label">Overdue Accounts</div>
        <div class="stat-trend">
            <i class="fas fa-arrow-up me-1"></i>{{ high_risk|default:"0" }} high risk
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Credit Trend Chart -->
    <div class="col-xl-8">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">
                    <i class="fas fa-chart-line"></i>Credit Trend (Last 30 Days)
                </h5>
                <span class="badge bg-light text-dark">Daily Credit Issued</span>
            </div>
            <div class="chart-wrapper">
                <canvas id="creditChart" style="width:100%; height:250px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Status Distribution -->
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">
                    <i class="fas fa-chart-pie"></i>Credit Status
                </h5>
                <span class="badge bg-light text-dark">Distribution</span>
            </div>
            <div class="chart-wrapper">
                <canvas id="statusChart" style="width:100%; height:250px;"></canvas>
            </div>
            <div class="mt-3">
                <div class="d-flex justify-content-between mb-2">
                    <span><span class="risk-indicator risk-low"></span> Active</span>
                    <span class="fw-bold">{{ active_credits|default:"0" }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span><span class="risk-indicator risk-medium"></span> Pending</span>
                    <span class="fw-bold">{{ pending_approval|default:"0" }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span><span class="risk-indicator risk-high"></span> Overdue</span>
                    <span class="fw-bold">{{ overdue_count|default:"0" }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Companies Performance and Due Payments -->
<div class="row g-4 mb-4">
    <!-- Companies Performance -->
    <div class="col-xl-6">
        <div class="table-container">
            <div class="table-header">
                <h5 class="table-title">
                    <i class="fas fa-building"></i>Credit Companies Performance
                </h5>
                <a href="{% url 'credit:company_list' %}" class="view-all-link">View All <i class="fas fa-arrow-right ms-2"></i></a>
            </div>
            
            {% for company in companies %}
            <div class="company-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <span class="badge-company mb-2">{{ company.code|default:"CRD" }}</span>
                        <div class="company-name">{{ company.name }}</div>
                    </div>
                    <div class="text-end">
                        <span class="fw-bold text-success">KES {{ company.total_credit|floatformat:0 }}</span>
                        <br>
                        <small class="text-muted">Total Credit</small>
                    </div>
                </div>
                <div class="company-stats">
                    <span><i class="fas fa-users me-1"></i>{{ company.customers }} customers</span>
                    <span><i class="fas fa-clock me-1"></i>{{ company.active }} active</span>
                    <span><i class="fas fa-exclamation-triangle me-1"></i>{{ company.overdue }} overdue</span>
                </div>
                <div class="progress-custom mt-2">
                    <div class="progress-bar-custom" style="width: {{ company.utilization }}%"></div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-4 text-muted">
                <i class="fas fa-building fa-3x mb-3"></i>
                <p class="mb-0">No credit companies found</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Due Payments Today -->
    <div class="col-xl-6">
        <div class="table-container">
            <div class="table-header">
                <h5 class="table-title">
                    <i class="fas fa-clock text-warning"></i>Payments Due Today
                </h5>
                <span class="badge bg-light text-dark">{{ due_today }} payments</span>
            </div>
            
            <div style="max-height: 400px; overflow-y: auto;">
                {% for payment in due_payments %}
                <div class="due-item">
                    <div>
                        <div class="due-customer">{{ payment.customer_name }}</div>
                        <div class="due-date">
                            <i class="far fa-clock me-1"></i>Due: {{ payment.due_date|time:"H:i" }}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="due-amount">KES {{ payment.amount|floatformat:0 }}</div>
                        <small class="text-muted">{{ payment.company }}</small>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                    <p class="mb-0">No payments due today</p>
                </div>
                {% endfor %}
            </div>
            
            {% if due_payments %}
            <div class="mt-3 text-center">
                <a href="{% url 'credit:collection_list' %}" class="btn btn-outline-custom btn-sm">Process Collections</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Transactions and Overdue Accounts -->
<div class="row g-4">
    <!-- Recent Credit Transactions -->
    <div class="col-xl-6">
        <div class="table-container">
            <div class="table-header">
                <h5 class="table-title">
                    <i class="fas fa-history"></i>Recent Credit Transactions
                </h5>
                <a href="{% url 'credit:transaction_list' %}" class="view-all-link">View All</a>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ref</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Company</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in recent_transactions %}
                        <tr>
                            <td>
                                <a href="{% url 'credit:transaction_detail' transaction.id %}" class="text-primary fw-bold">
                                    {{ transaction.reference|truncatechars:8 }}
                                </a>
                            </td>
                            <td>
                                <div class="fw-bold">{{ transaction.customer_name|truncatechars:15 }}</div>
                                <small class="text-muted">{{ transaction.customer_phone }}</small>
                            </td>
                            <td class="fw-bold text-highlight">KES {{ transaction.amount|floatformat:0 }}</td>
                            <td>{{ transaction.company_name|truncatechars:10 }}</td>
                            <td>
                                <span class="badge-{{ transaction.status }}">
                                    {{ transaction.status|title }}
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                <i class="fas fa-credit-card fa-2x mb-2"></i>
                                <p class="mb-0">No recent transactions</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Overdue Accounts -->
    <div class="col-xl-6">
        <div class="table-container">
            <div class="table-header">
                <h5 class="table-title">
                    <i class="fas fa-exclamation-triangle text-danger"></i>Overdue Accounts
                </h5>
                <span class="badge bg-danger text-white">{{ overdue_count }} accounts</span>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Days Overdue</th>
                            <th>Risk</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in overdue_accounts %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ account.customer_name }}</div>
                                <small class="text-muted">{{ account.phone }}</small>
                            </td>
                            <td class="fw-bold text-danger">KES {{ account.amount|floatformat:0 }}</td>
                            <td>
                                <span class="badge {% if account.days_overdue > 30 %}bg-danger{% elif account.days_overdue > 15 %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                    {{ account.days_overdue }} days
                                </span>
                            </td>
                            <td>
                                <span class="risk-indicator 
                                    {% if account.days_overdue > 30 %}risk-high
                                    {% elif account.days_overdue > 15 %}risk-medium
                                    {% else %}risk-low
                                    {% endif %}">
                                </span>
                                {% if account.days_overdue > 30 %}High
                                {% elif account.days_overdue > 15 %}Medium
                                {% else %}Low
                                {% endif %}
                            </td>
                            <td>
                                <a href="#" class="btn btn-sm btn-outline-warning" title="Contact Customer">
                                    <i class="fas fa-phone"></i>
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-info" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                                <p class="mb-0">No overdue accounts</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    $(document).ready(function() {
        console.log("âœ… Credit Manager Dashboard Loaded");
        console.log("Chart Labels:", {{ chart_labels|safe }});
        console.log("Chart Data:", {{ credit_data|safe }});
        
        // ============================================
        // CREDIT TREND CHART
        // ============================================
        var ctx1 = document.getElementById('creditChart');
        if (ctx1) {
            try {
                new Chart(ctx1.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: {{ chart_labels|safe }},
                        datasets: [{
                            label: 'Credit Issued (KES)',
                            data: {{ credit_data|safe }},
                            borderColor: '#6f42c1',
                            backgroundColor: 'rgba(111, 66, 193, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#6f42c1',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'KES ' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return 'KES ' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                console.log("âœ… Credit chart created successfully");
            } catch (e) {
                console.error("âŒ Error creating credit chart:", e);
            }
        } else {
            console.warn("âš ï¸ Credit chart canvas not found");
        }

        // ============================================
        // STATUS DISTRIBUTION CHART
        // ============================================
        var ctx2 = document.getElementById('statusChart');
        if (ctx2) {
            try {
                new Chart(ctx2.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Active', 'Pending', 'Overdue'],
                        datasets: [{
                            data: [
                                {{ active_credits|default:0 }},
                                {{ pending_approval|default:0 }},
                                {{ overdue_count|default:0 }}
                            ],
                            backgroundColor: [
                                '#28a745',
                                '#ffc107',
                                '#dc3545'
                            ],
                            borderWidth: 0,
                            hoverOffset: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.raw + ' transactions';
                                    }
                                }
                            }
                        },
                        cutout: '70%',
                        layout: {
                            padding: 10
                        }
                    }
                });
                console.log("âœ… Status chart created successfully");
            } catch (e) {
                console.error("âŒ Error creating status chart:", e);
            }
        } else {
            console.warn("âš ï¸ Status chart canvas not found");
        }

        // ============================================
        // ANIMATE NUMBERS
        // ============================================
        $('.stat-value').each(function() {
            var $this = $(this);
            var text = $this.text().replace('KES ', '').replace(/,/g, '');
            var countTo = parseFloat(text);
            
            if (!isNaN(countTo) && countTo > 0) {
                $({ countNum: 0 }).animate({ countNum: countTo }, {
                    duration: 1000,
                    easing: 'swing',
                    step: function() {
                        if ($this.text().includes('KES')) {
                            $this.text('KES ' + Math.floor(this.countNum).toLocaleString());
                        } else {
                            $this.text(Math.floor(this.countNum));
                        }
                    },
                    complete: function() {
                        if ($this.text().includes('KES')) {
                            $this.text('KES ' + countTo.toLocaleString());
                        } else {
                            $this.text(countTo);
                        }
                    }
                });
            }
        });

        // ============================================
        // AUTO-REFRESH EVERY 5 MINUTES
        // ============================================
        setTimeout(function() {
            console.log("ðŸ”„ Auto-refreshing dashboard...");
            location.reload();
        }, 300000); // 5 minutes
        
    }); // End of document ready
</script>
{% endblock %}
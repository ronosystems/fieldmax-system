{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Stock Alerts{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-exclamation-triangle me-2"></i>Stock Alerts</h2>
    <div>
        <span class="text-muted">Active Alerts: {{ alerts.count }}</span>
    </div>
</div>

<div class="row">
    {% for alert in alerts %}
    <div class="col-md-6 mb-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Low Stock Alert</h6>
                <span class="badge bg-dark">{{ alert.product.product_code }}</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-8">
                        <h5 class="mb-1">{{ alert.product.display_name }}</h5>
                        <p class="text-muted small mb-2">{{ alert.product.category.name }}</p>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Current Stock:</span>
                                <span class="fw-bold text-warning">{{ alert.product.quantity }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Alert Level:</span>
                                <span class="fw-bold">{{ alert.alert_level }}</span>
                            </div>
                            {% if alert.product.reorder_level %}
                            <div class="d-flex justify-content-between mb-2">
                                <span>Reorder Level:</span>
                                <span class="fw-bold">{{ alert.product.reorder_level }}</span>
                            </div>
                            {% endif %}
                            <div class="d-flex justify-content-between mb-2">
                                <span>Last Alerted:</span>
                                <span class="fw-bold">{{ alert.last_alerted|timesince|default:"Never" }} ago</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-4 text-center">
                        <div class="p-3 bg-light rounded">
                            <div class="display-4 text-warning">{{ alert.product.quantity }}</div>
                            <small class="text-muted">Current Stock</small>
                        </div>
                    </div>
                </div>
                
                <!-- Progress bar using widthratio -->
                <div class="progress mt-3 mb-3" style="height: 10px;">
                    {% with total=alert.alert_level current=alert.product.quantity %}
                        {% if total > 0 %}
                            <div class="progress-bar bg-warning" 
                                 role="progressbar" 
                                 style="width: {% widthratio current total 100 %}%;"
                                 aria-valuenow="{{ current }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ total }}">
                            </div>
                        {% else %}
                            <div class="progress-bar bg-warning" 
                                 role="progressbar" 
                                 style="width: 0%;">
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>
                
                <div class="d-flex gap-2">
                    <a href="{% url 'inventory:product_detail' alert.product.id %}" 
                       class="btn btn-sm btn-info flex-grow-1">
                        <i class="fas fa-eye"></i> View Product
                    </a>
                    <a href="{% url 'inventory:restock_product' alert.id %}" 
                       class="btn btn-sm btn-warning flex-grow-1">
                        <i class="fas fa-plus"></i> Restock
                    </a>
                    <button type="button" 
                            class="btn btn-sm btn-secondary" 
                            title="Dismiss Alert"
                            onclick="dismissAlert({{ alert.id }})">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h4>All Good!</h4>
                <p class="text-muted">No active stock alerts at the moment.</p>
                <a href="{% url 'inventory:product_list' %}" class="btn btn-primary mt-3">
                    <i class="fas fa-box"></i> View Products
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Dismiss Alert Modal -->
<div class="modal fade" id="dismissModal" tabindex="-1" aria-labelledby="dismissModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="dismissModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Dismiss Alert
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to dismiss this alert?</p>
                <p class="text-muted">The alert can be re-activated if stock levels drop again.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDismissBtn" class="btn btn-success">Dismiss</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';
    
    // Global function for dismissing alerts
    window.dismissAlert = function(alertId) {
        // Get modal element
        var modalElement = document.getElementById('dismissModal');
        if (!modalElement) return;
        
        // Create modal instance
        var modal = new bootstrap.Modal(modalElement);
        
        // Update confirm button URL
        var confirmBtn = document.getElementById('confirmDismissBtn');
        if (confirmBtn) {
            var baseUrl = "{% url 'inventory:dismiss_alert' 0 %}";
            var dismissUrl = baseUrl.replace('0', alertId.toString());
            confirmBtn.setAttribute('href', dismissUrl);
        }
        
        // Show modal
        modal.show();
    };
})();
</script>
{% endblock %}
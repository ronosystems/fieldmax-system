{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}{{ product.display_name }}{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'inventory:product_list' %}">Products</a></li>
            <li class="breadcrumb-item active">{{ product.display_name }}</li>
        </ol>
    </nav>
</div>

<div class="row">
    <!-- Product Details -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Product Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th>Product Code:</th>
                                <td><span class="badge bg-primary p-2">{{ product.product_code }}</span></td>
                            </tr>
                            <tr>
                                <th>Name:</th>
                                <td>{{ product.display_name }}</td>
                            </tr>
                            <tr>
                                <th>Category:</th>
                                <td>
                                    {% if product.category.is_single_item %}
                                        üì± {{ product.category.name }}
                                    {% else %}
                                        üì¶ {{ product.category.name }}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Brand:</th>
                                <td>{{ product.brand|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Model:</th>
                                <td>{{ product.model|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Condition:</th>
                                <td>
                                    {% if product.condition == 'new' %}
                                        <span class="text-success">‚óè Brand New</span>
                                    {% elif product.condition == 'refurbished' %}
                                        <span class="text-info">‚óè Refurbished</span>
                                    {% elif product.condition == 'used' %}
                                        <span class="text-warning">‚óè Used - Excellent</span>
                                    {% elif product.condition == 'used_good' %}
                                        <span class="text-warning">‚óè Used - Good</span>
                                    {% elif product.condition == 'used_fair' %}
                                        <span class="text-danger">‚óè Used - Fair</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th>SKU:</th>
                                <td>{{ product.sku_value|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Barcode:</th>
                                <td>{{ product.barcode|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Quantity:</th>
                                <td>
                                    <span class="fw-bold">{{ product.quantity }}</span>
                                    {% if product.needs_reorder %}
                                        <span class="badge bg-warning text-dark ms-2">Needs Reorder</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    {% if product.status == 'available' %}
                                        <span class="badge-available">‚úì Available</span>
                                    {% elif product.status == 'sold' %}
                                        <span class="badge-sold">‚úó Sold</span>
                                    {% elif product.status == 'reserved' %}
                                        <span class="badge-warning">‚è≥ Reserved</span>
                                    {% elif product.status == 'damaged' %}
                                        <span class="badge-danger">‚ö†Ô∏è Damaged</span>
                                    {% elif product.status == 'lowstock' %}
                                        <span class="badge-lowstock">‚ö†Ô∏è Low Stock</span>
                                    {% elif product.status == 'outofstock' %}
                                        <span class="badge-danger">‚ùå Out of Stock</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Warranty:</th>
                                <td>{{ product.warranty_months }} months</td>
                            </tr>
                            <tr>
                                <th>In Warranty:</th>
                                <td>
                                    {% if product.is_in_warranty %}
                                        <span class="text-success">‚úì Yes</span>
                                    {% else %}
                                        <span class="text-danger">‚úó No</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Specifications:</h6>
                        <div class="bg-light p-3 rounded">
                            {% if product.specifications %}
                                <div class="row">
                                    {% for key, value in product.specifications.items %}
                                    <div class="col-md-3 mb-2">
                                        <strong>{{ key|title }}:</strong> {{ value }}
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted mb-0">No specifications provided</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% if product.description %}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Description:</h6>
                        <p>{{ product.description|linebreaks }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Pricing Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Pricing Information</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted">Buying Price</small>
                            <h3 class="mb-0">KSH {{ product.buying_price|floatformat:0 }}</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted">Selling Price</small>
                            <h3 class="mb-0 text-success">KSH {{ product.selling_price|floatformat:0 }}</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted">Best Price</small>
                            <h3 class="mb-0 text-info">KSH {{ product.best_price|floatformat:0|default:"-" }}</h3>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h6>Profit Margin</h6>
                            <span class="display-6 {% if product.profit_margin > 0 %}text-success{% else %}text-danger{% endif %}">
                                KSH {{ product.profit_margin|floatformat:0 }}
                            </span>
                            <span class="ms-2">({{ product.profit_percentage|floatformat:1 }}%)</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h6>Price Difference (Sell - Best)</h6>
                            <span class="display-6">{{ product.price_difference|floatformat:0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stock Movement History -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Stock Movement History</h5>
                <a href="{% url 'inventory:stock_entry_add' product.id %}" class="btn btn-sm btn-success">
                    <i class="fas fa-plus"></i> Add Entry
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                                <th>Reference</th>
                                <th>By</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in stock_entries %}
                            <tr>
                                <td>{{ entry.created_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    {% if entry.entry_type == 'purchase' %}
                                        <span class="badge bg-success">Purchase</span>
                                    {% elif entry.entry_type == 'sale' %}
                                        <span class="badge bg-danger">Sale</span>
                                    {% elif entry.entry_type == 'reversal' %}
                                        <span class="badge bg-warning text-dark">Return</span>
                                    {% else %}
                                        <span class="badge bg-info">Adjustment</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if entry.quantity > 0 %}
                                        <span class="text-success fw-bold">+{{ entry.quantity }}</span>
                                    {% else %}
                                        <span class="text-danger fw-bold">{{ entry.quantity }}</span>
                                    {% endif %}
                                </td>
                                <td>KSH {{ entry.unit_price|floatformat:0 }}</td>
                                <td>KSH {{ entry.total_amount|floatformat:0 }}</td>
                                <td><small>{{ entry.reference_id|default:"-" }}</small></td>
                                <td>{{ entry.created_by.username|default:"System" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">No stock movements found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Product Image -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-image me-2"></i>Product Image</h5>
            </div>
            <div class="card-body text-center">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.display_name }}" class="img-fluid rounded" style="max-height: 200px;">
                {% else %}
                    <div class="bg-light p-5 rounded">
                        <i class="fas fa-image fa-4x text-muted"></i>
                        <p class="text-muted mt-2">No image available</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Additional Images -->
        {% if product.images.all %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-images me-2"></i>Additional Images</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    {% for img in product.images.all %}
                    <div class="col-4">
                        <img src="{{ img.image.url }}" class="img-thumbnail" alt="Product image" style="height: 80px; object-fit: cover;">
                        {% if img.is_primary %}
                            <small class="d-block text-center text-primary">Primary</small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Supplier Information -->
        {% if product.supplier %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-truck me-2"></i>Supplier</h5>
            </div>
            <div class="card-body">
                <h6>{{ product.supplier.name }}</h6>
                <p class="mb-1"><i class="fas fa-user me-2"></i>{{ product.supplier.contact_person|default:"-" }}</p>
                <p class="mb-1"><i class="fas fa-phone me-2"></i>{{ product.supplier.phone }}</p>
                <p class="mb-1"><i class="fas fa-envelope me-2"></i>{{ product.supplier.email|default:"-" }}</p>
                {% if product.supplier.address %}
                <p class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>{{ product.supplier.address }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Stock Alert -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Stock Alert</h5>
            </div>
            <div class="card-body">
                {% if product.category.is_bulk_item %}
                    <p>Reorder Level: <strong>{{ product.reorder_level|default:"Not set" }}</strong></p>
                    {% if product.needs_reorder %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Stock is below reorder level!
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Stock level is healthy
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted">Stock alerts not applicable for single items</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-grid gap-2">
            <a href="{% url 'inventory:product_edit' product.id %}" class="btn btn-warning">
                <i class="fas fa-edit me-2"></i>Edit Product
            </a>
            <a href="{% url 'inventory:stock_entry_add' product.id %}" class="btn btn-success">
                <i class="fas fa-plus-circle me-2"></i>Add Stock Entry
            </a>
            <a href="{% url 'inventory:product_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Products
            </a>
            <a href="{% url 'inventory:product_delete' product.id %}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this product?');">
                <i class="fas fa-trash me-2"></i>Delete Product
            </a>
            <a href="{% url 'inventory:product_add' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add Similar Product
            </a>
        </div>
    </div>
</div>
{% endblock %}